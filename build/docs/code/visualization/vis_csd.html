<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of vis_csd</title>
  <meta name="keywords" content="vis_csd">
  <meta name="description" content="plot current source density for a signal object.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">code</a> &gt; <a href="index.html">visualization</a> &gt; vis_csd.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for code/visualization&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>vis_csd
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>plot current source density for a signal object.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function gobj = vis_csd(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> plot current source density for a signal object.
 Input:
   hmObj:  Mobilab head model object associated with signal
   signal: the data struction (must contain .chanlocs, .data, and .srcpot 
           fields)
 Optional:
   times:  vectors of times (in seconds) to plot. If &gt; 1 a 'movie' is
           generated
   title:  figure title
   pausedelay:  delay between frames (seconds)
   clims:  color limits. If scalar, this is taken to be a percentile
           over signal.srcpot. otherwise limits should be provided in 
           [min max] form.

 Author: Tim Mullen, SCCN/INC/UCSD 2013</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [img_pause img_go] = loadimgs()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function gobj = vis_csd(varargin)</a>
0002 <span class="comment">% plot current source density for a signal object.</span>
0003 <span class="comment">% Input:</span>
0004 <span class="comment">%   hmObj:  Mobilab head model object associated with signal</span>
0005 <span class="comment">%   signal: the data struction (must contain .chanlocs, .data, and .srcpot</span>
0006 <span class="comment">%           fields)</span>
0007 <span class="comment">% Optional:</span>
0008 <span class="comment">%   times:  vectors of times (in seconds) to plot. If &gt; 1 a 'movie' is</span>
0009 <span class="comment">%           generated</span>
0010 <span class="comment">%   title:  figure title</span>
0011 <span class="comment">%   pausedelay:  delay between frames (seconds)</span>
0012 <span class="comment">%   clims:  color limits. If scalar, this is taken to be a percentile</span>
0013 <span class="comment">%           over signal.srcpot. otherwise limits should be provided in</span>
0014 <span class="comment">%           [min max] form.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Author: Tim Mullen, SCCN/INC/UCSD 2013</span>
0017 
0018 <span class="keyword">persistent</span> hcb
0019 
0020 <span class="comment">% extract some defaults</span>
0021 headmodel_default = <span class="string">'resources:/headmodels/standard-Colin27-385ch.mat'</span>;
0022 
0023 g=arg_define([0 Inf],varargin, <span class="keyword">...</span>
0024     arg({<span class="string">'hmObj'</span>,<span class="string">'HeadModelObject'</span>},headmodel_default,[],<span class="string">'Head model object generated by MOBILAB. See MOBILAB''s headModel class.'</span>), <span class="keyword">...</span>
0025     arg_norep({<span class="string">'signal'</span>,<span class="string">'Signal'</span>},[],[],<span class="string">'Signal structure. Must contain .srcpot field with csd and .data field with channel data'</span>), <span class="keyword">...</span>
0026     arg_nogui({<span class="string">'cortexMesh'</span>,<span class="string">'CortexMesh'</span>},[],[],<span class="string">'Cortex mesh. Optional. Faces and vertices of a cortical surface mesh. This overrides the default mesh stored in hmObj'</span>),<span class="keyword">...</span>
0027     arg({<span class="string">'times'</span>,<span class="string">'Times'</span>},[],[],<span class="string">'Vector of times (in seconds) to plot. If length(times) &gt; 1 a movie is generated'</span>), <span class="keyword">...</span>
0028     arg({<span class="string">'avgtimes'</span>,<span class="string">'AverageTimes'</span>},false,[],<span class="string">'Average across times'</span>), <span class="keyword">...</span>
0029     arg({<span class="string">'frameskip'</span>,<span class="string">'FrameSkip'</span>},2,[0 Inf],<span class="string">'Skip frames. Image will be generated every FramSkip frames'</span>), <span class="keyword">...</span>
0030     arg({<span class="string">'title'</span>,<span class="string">'Title'</span>},<span class="string">'Current Source Density'</span>,[],<span class="string">'Figure title'</span>), <span class="keyword">...</span>
0031     arg({<span class="string">'pausedelay'</span>,<span class="string">'PauseDelay'</span>},0,[0 Inf],<span class="string">'Delay between frames (seconds)'</span>), <span class="keyword">...</span>
0032     arg({<span class="string">'cortexlims'</span>,<span class="string">'CortexColorLimits'</span>},<span class="string">'globalmaxabs'</span>,[],<span class="string">'Cortex color limits. Can be ''localmax'', ''globalmaxabs'', or numeric in [min max] form or a scalar, which is taken to be a percentile over signal.srcpot.'</span>,<span class="string">'type'</span>,<span class="string">'expression'</span>,<span class="string">'shape'</span>,<span class="string">'row'</span>), <span class="keyword">...</span><span class="comment"> </span>
0033     arg({<span class="string">'scalplims'</span>,<span class="string">'ScalpColorLimits'</span>},<span class="string">'globalmaxabs'</span>,[],<span class="string">'Scalp color limits. Can be ''localmax'', ''globalmaxabs'', or numeric in [min max] form or a scalar, which is taken to be a percentile over signal.data.'</span>,<span class="string">'type'</span>,<span class="string">'expression'</span>,<span class="string">'shape'</span>,<span class="string">'row'</span>), <span class="keyword">...</span>
0034     arg({<span class="string">'showpower'</span>,<span class="string">'ShowPower'</span>},true,[],<span class="string">'Display power |CSD|^2'</span>), <span class="keyword">...</span>
0035     arg({<span class="string">'pauseBehavior'</span>,<span class="string">'PauseBehavior'</span>},<span class="string">'return'</span>,{<span class="string">'return'</span>,<span class="string">'hold'</span>},<span class="string">'Pause behavior. Action to take when pause button is pressed'</span>), <span class="keyword">...</span>
0036     arg_nogui({<span class="string">'gobj'</span>,<span class="string">'GraphicsObject'</span>},[],[],<span class="string">'Viewer Graphics Object. If empty a new figure is created. Otherwise, the graphics object is updated'</span>));
0037   
0038 arg_toworkspace(g);
0039 times = g.times;
0040 title = g.title;
0041 
0042 hmObj = hlp_validateHeadModelObject(hmObj);
0043 
0044 <span class="keyword">if</span> ~isfield(signal,<span class="string">'srcpot_all'</span>)
0045     error(<span class="string">'BCILAB:vis_csd:MissingSourcePotentials'</span>,<span class="string">'signal does not contain field ''srcpot_all''. Please make sure ''KeepFullCsd'' option is enabled in SourceLocalization (flt_sourceLocalize)'</span>); <span class="keyword">end</span>
0046 
0047 <span class="keyword">if</span> isempty(times)
0048     times = linspace(signal.xmin,signal.xmax,signal.pnts);
0049 <span class="keyword">elseif</span> size(times,1) &gt; size(times,2)
0050     times = times(:)';
0051 <span class="keyword">end</span>
0052 
0053 
0054 hmObj = copy(hmObj);
0055 tmp = hlp_microcache(<span class="string">'loadsurf'</span>,@load,hmObj.surfaces);
0056 surfData = tmp.surfData; clear tmp;
0057 
0058 <span class="comment">% overwrite the cortex surface</span>
0059 <span class="keyword">if</span> ~isempty(g.cortexMesh)
0060     surfData(3) = g.cortexMesh;
0061 <span class="keyword">end</span>
0062 <span class="comment">% surfData(3) = signal.dipfit.reducedMesh;</span>
0063 
0064 <span class="keyword">if</span> size(surfData(3).vertices,1)~=size(signal.srcpot_all,1)
0065     error(<span class="string">'the number of vertices on the surface mesh (%d) does not equal the number of sources (rows of signal.srcpot_all) (%d)'</span>,size(surfData(3).vertices,1),size(signal.srcpot_all,1));
0066 <span class="keyword">end</span>
0067 
0068 <span class="comment">% match the headmodel electrodes with those in the signal</span>
0069 chanlabels = lower({signal.chanlocs.labels});
0070 lookup = lower(hmObj.label);
0071 <span class="comment">% got channel names: look them up from the chanlocs, but ordered according to lookup</span>
0072 [x,a,b] = intersect(lookup,chanlabels); <span class="comment">%#ok&lt;ASGLU&gt;</span>
0073 [x,I] = sort(a); remaining = b(I);
0074 hmObj.label = hmObj.label(x);   
0075 hmObj.channelSpace = hmObj.channelSpace(x,:);
0076 signal.data = signal.data(remaining,:,:);
0077 
0078 <span class="comment">% convert times to samples</span>
0079 <span class="comment">% FIXME: this assumes that xmin = 0. need to adjust for that</span>
0080 sampletimes = round((times-signal.xmin)*signal.srate)+1;
0081 srcpot = signal.srcpot_all(:,sampletimes);
0082 data   = signal.data(:,sampletimes);
0083 
0084 <span class="keyword">if</span> showpower
0085     <span class="comment">% compute power</span>
0086     srcpot = abs(srcpot).^2;
0087     data   = abs(data).^2;
0088 <span class="keyword">end</span>
0089 
0090 <span class="keyword">if</span> frameskip&gt;0
0091     sampletimes = sampletimes(1:frameskip:end); <span class="keyword">end</span>
0092 <span class="keyword">if</span> avgtimes
0093     srcpot = mean(srcpot,2);
0094     data   = mean(data,2);
0095     times  = mean(times);
0096     sampletimes = 1;
0097 <span class="keyword">end</span>
0098 
0099 <span class="comment">% translate the colorlimits</span>
0100 <span class="keyword">if</span> ~(isnumeric(cortexlims) &amp;&amp; length(cortexlims)==2)
0101     <span class="keyword">if</span> isequal(cortexlims,<span class="string">'globalmaxabs'</span>) || isequal(cortexlims,100)
0102         mx = max(abs(srcpot(:)))+eps;
0103         cortexlims = [-mx mx]; 
0104     <span class="keyword">elseif</span> isequal(cortexlims,<span class="string">'localmax'</span>)
0105         cortexlims = [];
0106     <span class="keyword">elseif</span> isscalar(cortexlims)
0107         mx = prctile(srcpot(:),cortexlims)+eps;
0108         cortexlims = [-mx mx]; 
0109     <span class="keyword">end</span>
0110 <span class="keyword">end</span>
0111 
0112 <span class="keyword">if</span> ~(isnumeric(scalplims) &amp;&amp; length(scalplims)==2)
0113     <span class="keyword">if</span> isequal(scalplims,<span class="string">'globalmaxabs'</span>) || isequal(scalplims,100)
0114         mx = max(abs(srcpot(:)))+eps;
0115         scalplims = [-mx mx]; 
0116     <span class="keyword">elseif</span> isequal(scalplims,<span class="string">'localmax'</span>)
0117         scalplims = [];
0118     <span class="keyword">elseif</span> isscalar(scalplims)
0119         mx = prctile(data(:),scalplims)+eps;
0120         scalplims = [-mx mx]; 
0121     <span class="keyword">end</span>
0122 <span class="keyword">end</span>
0123         
0124         
0125 <span class="comment">% plot the surface</span>
0126 <span class="keyword">try</span>
0127     <span class="keyword">for</span> t=1:length(sampletimes)
0128         <span class="keyword">if</span> isempty(gobj) &amp;&amp; t==1
0129             <span class="comment">% initialize figure</span>
0130             gobj = currentSourceViewer(hmObj,srcpot(:,t),data(:,t),title,hmObj.label,[],surfData,cortexlims,times(t));
0131 
0132             [img_pause img_go] = hlp_microcache(<span class="string">'viscsd'</span>,@<a href="#_sub1" class="code" title="subfunction [img_pause img_go] = loadimgs()">loadimgs</a>);
0133             toolbarHandle = findall(gobj.hFigure,<span class="string">'Type'</span>,<span class="string">'uitoolbar'</span>);
0134             hcb = uitoggletool(toolbarHandle,<span class="string">'CData'</span>,img_pause,<span class="string">'Separator'</span>,<span class="string">'off'</span>,<span class="string">'HandleVisibility'</span>,<span class="string">'off'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Pause/Unpause'</span>,<span class="string">'userData'</span>,<span class="string">'go'</span>,<span class="string">'State'</span>,<span class="string">'off'</span>);
0135             set(hcb,<span class="string">'OnCallback'</span>, @(src,event) set(src,<span class="string">'userdata'</span>,<span class="string">'pause'</span>,<span class="string">'CData'</span>,img_go), <span class="keyword">...</span>
0136                     <span class="string">'OffCallback'</span>,@(src,event) set(src,<span class="string">'userdata'</span>,<span class="string">'go'</span>,<span class="string">'CData'</span>,img_pause));
0137         <span class="keyword">else</span>
0138             <span class="keyword">if</span> strcmp(get(hcb,<span class="string">'userdata'</span>),<span class="string">'pause'</span>)
0139                 <span class="keyword">if</span> strcmp(g.pauseBehavior,<span class="string">'return'</span>)
0140                     <span class="keyword">return</span>;
0141                 <span class="keyword">elseif</span> strcmp(g.pauseBehavior,<span class="string">'hold'</span>)
0142                     waitfor(hcb,<span class="string">'userdata'</span>,<span class="string">'go'</span>);
0143                 <span class="keyword">end</span>
0144             <span class="keyword">end</span>
0145 
0146             <span class="comment">% update figure</span>
0147             <span class="keyword">if</span> ~ishandle(gobj.hFigure)
0148                 <span class="keyword">return</span>; 
0149             <span class="keyword">end</span>
0150 
0151             <span class="keyword">if</span> strcmp(get(gobj.hScalp,<span class="string">'visible'</span>),<span class="string">'on'</span>)
0152                 <span class="comment">% use scalp colorlimits</span>
0153                 clims = scalplims;
0154             <span class="keyword">else</span>
0155                 clims = cortexlims;
0156             <span class="keyword">end</span>
0157 
0158             <span class="keyword">try</span>
0159                 gobj = currentSourceViewer(hmObj,srcpot(:,t),data(:,t),title,hmObj.label,gobj,surfData,clims,times(t));
0160             <span class="keyword">catch</span> err
0161                 <span class="keyword">if</span> strcmp(err.identifier,<span class="string">'MATLAB:class:InvalidHandle'</span>)
0162                     <span class="keyword">return</span>; 
0163                 <span class="keyword">end</span>
0164             <span class="keyword">end</span>
0165         <span class="keyword">end</span>
0166         <span class="comment">%     refresh(gobj.hFigure);</span>
0167         <span class="keyword">if</span> pausedelay &gt; 0
0168             pause(pausedelay+eps);
0169         <span class="keyword">else</span>
0170             drawnow;
0171         <span class="keyword">end</span>
0172     
0173     <span class="keyword">end</span>
0174 <span class="keyword">catch</span> err
0175     disp(err.message);
0176 <span class="keyword">end</span>
0177 
0178         
0179 <a name="_sub1" href="#_subfunctions" class="code">function [img_pause img_go] = loadimgs()</a>
0180 mPath = which(<span class="string">'mobilabApplication'</span>);
0181 path = fullfile(fileparts(mPath),<span class="string">'skin'</span>);
0182 img_pause  = imread([path filesep <span class="string">'1339562143_player_pause.png'</span>]);
0183 img_go = imread([path filesep <span class="string">'1339561905_player_play.png'</span>]);
0184 
0185</pre></div>
<hr><address>Generated on Tue 20-Aug-2013 03:44:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>